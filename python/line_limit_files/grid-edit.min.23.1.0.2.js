let xs;let uniqueid;const IMAGE_DIV="imagedive";const BASIC_Z_ORDER=5678;let sheets=[];const FOLDER_NAME=decodeURIComponent(getQueryString("FolderName"));const FILE_NAME=decodeURIComponent(getQueryString("FileName"));const PASSWORD=decodeURIComponent(getQueryString("Password"));const CALLBACK_URL=o.CallbackURL;const API_BASE_PATH=o.APIBasePath;const UID=decodeURIComponent(getQueryString("Uid"));$(function(){if(IsNullOrEmpty(FOLDER_NAME)||IsNullOrEmpty(FILE_NAME)){closeWindow()}else{$("#file_name").text(FILE_NAME);getDetailJson();$("#confirmClose").on("click",function(){$("#confirmCloseModal").modal({keyboard:true})});$("#confirmCloseModal").on("show.bs.modal",function(){$("#langModal").css("display","flex")});const e=async()=>{$.getScript(`${o.JsPath}/bootstrap.min.${o.JsVersionSuffix}`);$.getScript(`${o.JsPath}/jszip.min.${o.JsVersionSuffix}`);$.getScript(`${o.JsPath}/pako.min.${o.JsVersionSuffix}`);$.getScript(`https://apis.google.com/js/api.js`,function(){gapiLoaded()});$.getScript(`https://accounts.google.com/gsi/client`,function(){gisLoaded()})};e().then()}});function getDetailJson(){const e=`${API_BASE_PATH}EditorApi/DetailJson`;$.ajax({method:"POST",url:e,data:JSON.stringify({file:FILE_NAME,folder:FOLDER_NAME,password:PASSWORD,uid:UID}),contentType:"application/json",timeout:o.MillisecondsTimeout,cache:false,beforeSend:t,error:n,success:a});function t(){}function n(e){if(e!==undefined&&e.Status!==undefined){alert(e.Status);closeWindow();return}if(e.responseJSON!==undefined&&e.responseJSON.Status!==undefined){alert(e.responseJSON.Status);closeWindow();return}alert("Error");closeWindow()}function a(e){const t=JSON.parse(e);if(t.Error){alert(t.Error);closeWindow()}else{$(".content-wrapper").css("background","none");load(t)}}}function load(e){uniqueid=e.uniqueid;e.data.forEach(e=>{if(e.rows.len<50){e.rows.len=50}});sheets=e.data;const t=`${API_BASE_PATH}EditorApi/ImageUrl`;const o=`${API_BASE_PATH}EditorApi/UpdateCell`;xs=x_spreadsheet("#xs-div",{updateMode:"server",updateUrl:o,mode:"edit",folderName:FOLDER_NAME,fileName:FILE_NAME,local:getLocale()}).loadData(sheets).updateCellError(e=>{alert(e)});if(!e.showtabs){xs.bottombar.hide()}$(".x-spreadsheet-overlayer-content").append(`<div id="${IMAGE_DIV}" style="position:relative" /> `);const n=$(`#${IMAGE_DIV}`);const a=`${API_BASE_PATH}EditorApi/AddImage`;const s=`${API_BASE_PATH}EditorApi/AddImageByUrl`;const i=`${API_BASE_PATH}EditorApi/CopyImage`;xs.setUniqueId(uniqueid);xs.setImageInfo(n,t,a,s,i,BASIC_Z_ORDER);const l=xs.bottombar.swapFunc;xs.bottombar.swapFunc=function(e){l(e);if(xs.sheet.data.autoFilter.filters.length>0){xs.sheet.data.resetAutoFilter();xs.sheet.data.deleteExceptRowHideForAutoFilter()}};xs.setActiveSheetByName(e.actname).setActiveCell(e.actrow,e.actcol);$.fn.scrollEnd=function(t,o){$(this).scroll(function(){const e=$(this);if(e.data("scrollTimeout")){clearTimeout(e.data("scrollTimeout"))}e.data("scrollTimeout",setTimeout(t,o))})};xs.setFileDownloadCallFunction(save);xs.setFileName(FILE_NAME);const c=`${API_BASE_PATH}EditorApi/Ole`;xs.setOleDownloadInfo(c)}function downloadExportFile(e,t){const o=document.createElement("a");let n=e;if(typeof e=="string"){o.target="_blank"}else{n=window.URL.createObjectURL(e)}o.href=n;o.download=t;document.body.appendChild(o);o.click();document.body.removeChild(o);if(typeof e!="string"){window.URL.revokeObjectURL(n)}}function zip(e){const t=pako.gzip(e);return new Blob([t])}function save(e,t,o){try{showMask();const n=xs.datas;delete n.history;delete n.search;delete n.images;delete n.shapes;const a={p:{sheetname:xs.sheet.data.name,actrow:xs.sheet.data.selector.ri,actcol:xs.sheet.data.selector.ci,datas:xs.getUpdateDatas()},uid:uniqueid,file:e,folderName:FOLDER_NAME,outputType:t,password:PASSWORD};const s=zip(JSON.stringify(a));const i=`${API_BASE_PATH}EditorApi/Download`;$.ajax({method:"POST",url:i,header:{contentType:"application/octet-stream","Content-Encoding":"gzip"},data:s,processData:false,success:e=>{closeMask();if(e.StatusCode===200){switch(o){case"GoogleDrive":SaveToGoogleDrive(e.DownloadFileLink,e.FileName);break;case"Dropbox":SaveToDropbox(e.DownloadFileLink,e.FileName);break;case"Device":SaveToLocal(e.DownloadFileLink,e.FileName);break;default:alert("Download failed, please try again");break}}else{alert("Download failed, please try again")}},error:()=>{closeMask();alert("Download failed, please try again")}})}catch(e){closeMask();alert("Download failed, please try again")}}function fallbackCopyTextToClipboard(e){const t=document.createElement("textarea");t.value=e;t.style.position="fixed";t.style.top="0";t.style.left="0";document.body.appendChild(t);t.focus();t.select();document.execCommand("copy");document.body.removeChild(t)}function copyTextToClipboard(e){if(!navigator.clipboard){fallbackCopyTextToClipboard(e);return}navigator.clipboard.writeText(e).then()}function getQueryString(e){const t=new RegExp(`(^|&)${e}=([^&]*)(&|$)`);const o=window.location.search.substr(1).match(t);if(o!=null)return decodeURI(o[2]);return""}function closeWindow(){if(window.parent&&window.parent.closeIframe){window.parent.closeIframe()}else{window.location.href=CALLBACK_URL}}function showMask(){const e=document.createElement("div");e.id="aspose_mask_bg";e.style.position="absolute";e.style.top="0px";e.style.left="0px";e.style.width="100%";e.style.height="100%";e.style.backgroundColor="#777";e.style.opacity="0.6";e.style.zIndex="10001";document.body.appendChild(e);const t=document.createElement("div");t.style.position="absolute";t.style.top="33%";t.style.left="40%";t.style.backgroundColor="white";t.style.border="#336699 1px solid";t.style.textAlign="center";t.style.fontSize="medium";t.style.padding="1.5em 4em 1.5em 4em";t.innerText="Downloading, please wait...";e.appendChild(t)}function closeMask(){const e=document.getElementById("aspose_mask_bg");if(e!=null)e.parentNode.removeChild(e)}function getLocale(){const e=["en","zh","ru","es","pt","de","nl"];return e.includes(o.Locale)?o.Locale:"en"}const SCOPES="https://www.googleapis.com/auth/drive.file";const CLIENT_ID=o.GoogleDriveClientId;let tokenClient;let accessToken=null;let pickerInited=false;let gisInited=false;function gapiLoaded(){gapi.load("picker",intializePicker)}function intializePicker(){pickerInited=true}function gisLoaded(){tokenClient=google.accounts.oauth2.initTokenClient({client_id:CLIENT_ID,scope:SCOPES,callback:""});gisInited=true}function SaveToGoogleDrive(t,o){tokenClient.callback=async e=>{if(e.error!==undefined){throw e}accessToken=e.access_token;fetch(t).then(e=>e.blob()).then(e=>{const t=new FormData;t.append("metadata",new Blob([JSON.stringify({name:o})],{type:"application/json"}));t.append("file",e);fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:new Headers({Authorization:`Bearer ${accessToken}`}),body:t}).then(e=>e.json(),e=>alert(`Failed to save to Google Drive`)).then(()=>{alert(`Successfully saved to Google Drive`)})})};if(accessToken===null){tokenClient.requestAccessToken({prompt:"consent"})}else{tokenClient.requestAccessToken({prompt:""})}}function SaveToDropbox(e,t){const o={success:function(){alert(`Successfully saved to Dropbox`)},progress:function(){},cancel:function(){},error:function(){alert(`Failed to save to Dropbox`)}};Dropbox.save(e,t,o)}function SaveToLocal(e,t){fetch(e).then(e=>e.blob(),e=>alert("Download failed, please try again")).then(e=>downloadExportFile(e,t))}function IsNullOrEmpty(e){return e==null||e===""||e==="null"||e==="undefined"}